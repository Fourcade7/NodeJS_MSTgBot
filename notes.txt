import express from "express";
import TelegramBot from "node-telegram-bot-api";
import fs from "fs";

// 1ï¸âƒ£ Telegram tokeningizni bu yerga kiriting
const token = "7956623814:AAH_7h2nIVLG9TGsq4CaweY1yBui_CGiWCk";

// 2ï¸âƒ£ Telegram botni yaratamiz (polling rejimida)
const bot = new TelegramBot(token, { polling: true });

// 3ï¸âƒ£ Express app yaratamiz
const app = express();
const PORT = 3000;

// ==========================
// ğŸ“© TELEGRAM BOT QISMI
// ==========================

// Foydalanuvchilar fayli
const USERS_FILE = "./users.json";

// Fayl mavjud boâ€˜lmasa â€” yaratamiz
if (!fs.existsSync(USERS_FILE)) fs.writeFileSync(USERS_FILE, JSON.stringify([]));

// /start komandasi
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const name = msg.from.first_name;

  // Faylni oâ€˜qish
  let users = [];
  if (fs.existsSync(USERS_FILE)) {
    users = JSON.parse(fs.readFileSync(USERS_FILE, "utf-8"));
  }

  // Foydalanuvchi mavjudligini tekshirish
  const mavjud = users.find((u) => u.chatId === chatId);

  // Agar mavjud boâ€˜lmasa, qoâ€˜shamiz
  if (!mavjud) {
    users.push({ chatId, first_name: name });
    fs.writeFileSync(USERS_FILE, JSON.stringify(users, null, 2));
    console.log(`ğŸ“¥ Yangi foydalanuvchi qoâ€˜shildi: ${name} (${chatId})`);
  }

  bot.sendMessage(chatId, "Ğ—Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ, Ğ´Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² ĞœĞ¾Ğ¹Ğ¡ĞºĞ»Ğ°Ğ´ Info Ğ±Ğ¾Ñ‚ \n\n\nĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¼Ğ½Ğµ ÑĞ²Ğ¾Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸. ğŸ“", {
    reply_markup: {
      keyboard: [
        //["ğŸ‘‹ Salom de!"], // <-- Bitta tugma
        //["Negap de!"], // <-- Bitta tugma
        [
          { text: "ğŸ“ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°", request_contact: true },
          //{ text: "â„¹ï¸ Haqida" }

        ],
        
      ],
       
      resize_keyboard: true, // Tugmani ekranga moslashtiradi
      one_time_keyboard: true, // ğŸ‘ˆ Shu qator tugmani bosgandan keyin yoâ€˜q qilad
    },
  });
});

// ğŸ“² Foydalanuvchi kontakt yuborganda
bot.on("contact", (msg) => {
  const chatId = msg.chat.id;
  const phoneNumber = msg.contact.phone_number;
  const name = msg.contact.first_name;

   // Faylni oâ€˜qish
  let users = [];
  if (fs.existsSync(USERS_FILE)) {
    users = JSON.parse(fs.readFileSync(USERS_FILE, "utf-8"));
  }

  // Foydalanuvchi mavjudligini tekshirish
  const mavjud = users.find((u) => u.chatId === chatId);

  // Agar mavjud boâ€˜lmasa, qoâ€˜shamiz
  if (!mavjud) {
    users.push({ chatId, first_name: name ,phoneNumber});
    fs.writeFileSync(USERS_FILE, JSON.stringify(users, null, 2));
    console.log(`ğŸ“¥ Yangi foydalanuvchi qoâ€˜shildi: ${name} (${chatId})`);
  }

  bot.sendMessage(
    chatId,
    `âœ… Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾ ${name}, Ñ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»Ñ Ğ²Ğ°Ğ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ ${chatId}`
  );
});

// bot.on("message", async (msg) => {
//   const chatId = msg.chat.id;
//   const text = msg.text;

//   bot.sendMessage(chatId, `Salom, ${msg.from.first_name}! Siz yozdingiz: ${text}`);
// });

// ==========================
// ğŸŒ EXPRESS ROUTES
// ==========================

// 1ï¸âƒ£ GET request (fetch bilan misol)
app.get("/api", async (req, res) => {
  try {
    const response = await fetch("https://jsonplaceholder.typicode.com/posts/1");
    const data = await response.json();

    res.json({
      message: "âœ… GET TELEGRAM request ishladi!",
      data,
    });
  } catch (error) {
    console.error("âŒ Xatolik:", error);
    res.status(500).send("Xatolik yuz berdi");
  }
});

// 2ï¸âƒ£ Oddiy GET request
app.get("/", (req, res) => {
  res.send("Salom, bu oddiy GET request!");
});

// 3ï¸âƒ£ Yana bitta misol
app.get("/about", (req, res) => {
  res.json({ message: "Bu /about sahifasi", author: "Muxlisa" });
});

// ==========================
// ğŸš€ SERVERNI ISHGA TUSHIRISH
// ==========================
app.listen(PORT, () => {
  console.log(`ğŸš€ Server http://localhost:${PORT} da ishlayapti`);
});
















import TelegramBot from "node-telegram-bot-api";
const token = "YOUR_BOT_TOKEN";
const bot = new TelegramBot(token, { polling: true });

// ğŸŸ¢ /start komandasi
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const name = msg.from.first_name;

  bot.sendMessage(chatId, `ğŸ‘‹ Salom, ${name}!\nQuyidagi menyudan tanlang:`, {
    reply_markup: {
      keyboard: [
        [{ text: "ğŸ  Asosiy sahifa" }],
        [{ text: "â„¹ï¸ Ma'lumot" }],
        [{ text: "ğŸ“ Aloqa" }],
      ],
      resize_keyboard: true,
      one_time_keyboard: false, // Menyu doim koâ€˜rinsin
    },
  });
});

// ğŸ  Asosiy sahifa
bot.onText(/ğŸ  Asosiy sahifa/, (msg) => {
  bot.sendMessage(msg.chat.id, "Bu asosiy sahifa ğŸ˜Š");
});

// â„¹ï¸ Ma'lumot
bot.onText(/â„¹ï¸ Ma'lumot/, (msg) => {
  bot.sendMessage(msg.chat.id, "Bu bot Muxlisa tomonidan ishlab chiqilgan ğŸ¤–");
});

// ğŸ“ Aloqa
bot.onText(/ğŸ“ Aloqa/, (msg) => {
  bot.sendMessage(msg.chat.id, "Bogâ€˜lanish uchun: @elonlaruz");
});








bot.setMyCommands([
  { command: "/start", description: "Botni ishga tushirish ğŸš€" },
  { command: "/help", description: "Yordam olish â„¹ï¸" },
  { command: "/stop", description: "Botni toâ€˜xtatish ğŸ›‘" },
]);




// ğŸŸ¢ 2ï¸âƒ£ /start komandasi
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, "ğŸ‘‹ Salom! Men ishga tushdim.\nQuyidagi komandalarni menyudan tanlang.");
});

// â„¹ï¸ 3ï¸âƒ£ /help komandasi
bot.onText(/\/help/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(
    chatId,
    "ğŸ§­ Yordam:\n\n/start â€” botni ishga tushirish\n/help â€” yordam\n/stop â€” toâ€˜xtatish"
  );
});

// ğŸ›‘ 4ï¸âƒ£ /stop komandasi
bot.onText(/\/stop/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, "ğŸ‘‹ Xayr! Bot toâ€˜xtatildi.");
});