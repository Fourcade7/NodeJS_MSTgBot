import express from "express";
import TelegramBot from "node-telegram-bot-api";
import fs from "fs";

// 1️⃣ Telegram tokeningizni bu yerga kiriting
const token = "7956623814:AAH_7h2nIVLG9TGsq4CaweY1yBui_CGiWCk";

// 2️⃣ Telegram botni yaratamiz (polling rejimida)
const bot = new TelegramBot(token, { polling: true });

// 3️⃣ Express app yaratamiz
const app = express();
const PORT = 3000;

// ==========================
// 📩 TELEGRAM BOT QISMI
// ==========================

// Foydalanuvchilar fayli
const USERS_FILE = "./users.json";

// Fayl mavjud bo‘lmasa — yaratamiz
if (!fs.existsSync(USERS_FILE)) fs.writeFileSync(USERS_FILE, JSON.stringify([]));

// /start komandasi
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const name = msg.from.first_name;

  // Faylni o‘qish
  let users = [];
  if (fs.existsSync(USERS_FILE)) {
    users = JSON.parse(fs.readFileSync(USERS_FILE, "utf-8"));
  }

  // Foydalanuvchi mavjudligini tekshirish
  const mavjud = users.find((u) => u.chatId === chatId);

  // Agar mavjud bo‘lmasa, qo‘shamiz
  if (!mavjud) {
    users.push({ chatId, first_name: name });
    fs.writeFileSync(USERS_FILE, JSON.stringify(users, null, 2));
    console.log(`📥 Yangi foydalanuvchi qo‘shildi: ${name} (${chatId})`);
  }

  bot.sendMessage(chatId, "Здравствуйте, добро пожаловать в МойСклад Info бот \n\n\nОтправьте мне свой номер телефона для получения информации. 📞", {
    reply_markup: {
      keyboard: [
        //["👋 Salom de!"], // <-- Bitta tugma
        //["Negap de!"], // <-- Bitta tugma
        [
          { text: "📞 Отправить номер телефона", request_contact: true },
          //{ text: "ℹ️ Haqida" }

        ],
        
      ],
       
      resize_keyboard: true, // Tugmani ekranga moslashtiradi
      one_time_keyboard: true, // 👈 Shu qator tugmani bosgandan keyin yo‘q qilad
    },
  });
});

// 📲 Foydalanuvchi kontakt yuborganda
bot.on("contact", (msg) => {
  const chatId = msg.chat.id;
  const phoneNumber = msg.contact.phone_number;
  const name = msg.contact.first_name;

   // Faylni o‘qish
  let users = [];
  if (fs.existsSync(USERS_FILE)) {
    users = JSON.parse(fs.readFileSync(USERS_FILE, "utf-8"));
  }

  // Foydalanuvchi mavjudligini tekshirish
  const mavjud = users.find((u) => u.chatId === chatId);

  // Agar mavjud bo‘lmasa, qo‘shamiz
  if (!mavjud) {
    users.push({ chatId, first_name: name ,phoneNumber});
    fs.writeFileSync(USERS_FILE, JSON.stringify(users, null, 2));
    console.log(`📥 Yangi foydalanuvchi qo‘shildi: ${name} (${chatId})`);
  }

  bot.sendMessage(
    chatId,
    `✅ Спасибо ${name}, я сейчас отправлю вам информацию ${chatId}`
  );
});

// bot.on("message", async (msg) => {
//   const chatId = msg.chat.id;
//   const text = msg.text;

//   bot.sendMessage(chatId, `Salom, ${msg.from.first_name}! Siz yozdingiz: ${text}`);
// });

// ==========================
// 🌐 EXPRESS ROUTES
// ==========================

// 1️⃣ GET request (fetch bilan misol)
app.get("/api", async (req, res) => {
  try {
    const response = await fetch("https://jsonplaceholder.typicode.com/posts/1");
    const data = await response.json();

    res.json({
      message: "✅ GET TELEGRAM request ishladi!",
      data,
    });
  } catch (error) {
    console.error("❌ Xatolik:", error);
    res.status(500).send("Xatolik yuz berdi");
  }
});

// 2️⃣ Oddiy GET request
app.get("/", (req, res) => {
  res.send("Salom, bu oddiy GET request!");
});

// 3️⃣ Yana bitta misol
app.get("/about", (req, res) => {
  res.json({ message: "Bu /about sahifasi", author: "Muxlisa" });
});

// ==========================
// 🚀 SERVERNI ISHGA TUSHIRISH
// ==========================
app.listen(PORT, () => {
  console.log(`🚀 Server http://localhost:${PORT} da ishlayapti`);
});
















import TelegramBot from "node-telegram-bot-api";
const token = "YOUR_BOT_TOKEN";
const bot = new TelegramBot(token, { polling: true });

// 🟢 /start komandasi
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const name = msg.from.first_name;

  bot.sendMessage(chatId, `👋 Salom, ${name}!\nQuyidagi menyudan tanlang:`, {
    reply_markup: {
      keyboard: [
        [{ text: "🏠 Asosiy sahifa" }],
        [{ text: "ℹ️ Ma'lumot" }],
        [{ text: "📞 Aloqa" }],
      ],
      resize_keyboard: true,
      one_time_keyboard: false, // Menyu doim ko‘rinsin
    },
  });
});

// 🏠 Asosiy sahifa
bot.onText(/🏠 Asosiy sahifa/, (msg) => {
  bot.sendMessage(msg.chat.id, "Bu asosiy sahifa 😊");
});

// ℹ️ Ma'lumot
bot.onText(/ℹ️ Ma'lumot/, (msg) => {
  bot.sendMessage(msg.chat.id, "Bu bot Muxlisa tomonidan ishlab chiqilgan 🤖");
});

// 📞 Aloqa
bot.onText(/📞 Aloqa/, (msg) => {
  bot.sendMessage(msg.chat.id, "Bog‘lanish uchun: @elonlaruz");
});








bot.setMyCommands([
  { command: "/start", description: "Botni ishga tushirish 🚀" },
  { command: "/help", description: "Yordam olish ℹ️" },
  { command: "/stop", description: "Botni to‘xtatish 🛑" },
]);




// 🟢 2️⃣ /start komandasi
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, "👋 Salom! Men ishga tushdim.\nQuyidagi komandalarni menyudan tanlang.");
});

// ℹ️ 3️⃣ /help komandasi
bot.onText(/\/help/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(
    chatId,
    "🧭 Yordam:\n\n/start — botni ishga tushirish\n/help — yordam\n/stop — to‘xtatish"
  );
});

// 🛑 4️⃣ /stop komandasi
bot.onText(/\/stop/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, "👋 Xayr! Bot to‘xtatildi.");
});